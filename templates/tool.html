<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BMS Controller Selection Tool</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        .step { display: none; }
        .step.active { display: block; }
        .file-drop-zone { border: 2px dashed #cbd5e1; border-radius: 0.5rem; padding: 2rem; text-align: center; transition: all 0.2s ease-in-out; }
        .file-drop-zone.dragover { border-color: #3b82f6; background-color: #eff6ff; }
        .file-drop-zone.loaded { border-color: #22c55e; background-color: #f0fdf4; }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #3b82f6; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">

    <div class="container mx-auto p-4 md:p-8 max-w-7xl">
        <header class="text-center mb-8 relative">
            <h1 class="text-3xl md:text-4xl font-bold text-gray-900">BMS Controller Selection Tool</h1>
            <p class="text-lg text-gray-600 mt-2">A web application powered by Python for intelligent, cost-driven selections.</p>
            <!-- Logout Button -->
            <a href="/logout" class="absolute top-0 right-0 bg-red-500 hover:bg-red-600 text-white font-semibold py-2 px-4 rounded-lg text-sm transition-colors">Logout</a>
        </header>

        <main class="bg-white p-6 md:p-8 rounded-xl shadow-lg">
            <!-- Step 1: File Upload -->
            <div id="step-1" class="step active">
                <h2 class="text-2xl font-semibold mb-2">Step 1: Upload Your Panels Schedule</h2>
                <p class="text-gray-600 mb-6">Please upload the `panels.csv` file for your project.</p>
                <div class="max-w-xl mx-auto">
                    <div id="panels-drop-zone" class="file-drop-zone">
                        <label for="panels-file" class="cursor-pointer">
                            <h3 class="font-semibold text-gray-700">Panels Schedule</h3>
                            <p class="text-sm text-gray-500 mt-1" id="panels-status">Drag & Drop or Click to Upload</p>
                            <input type="file" id="panels-file" class="hidden" accept=".csv">
                        </label>
                    </div>
                </div>
                <div class="mt-8 text-right">
                    <button id="to-step-2" class="bg-blue-600 text-white font-semibold py-2 px-6 rounded-lg shadow-md hover:bg-blue-700 disabled:bg-gray-300 disabled:cursor-not-allowed transition-colors" disabled>
                        Next: Project Setup &rarr;
                    </button>
                </div>
            </div>
            <!-- Other steps (2, 3, 4) and JavaScript are unchanged from the previous correct version... -->
            <!-- Step 2: Project Setup & Server Selection -->
            <div id="step-2" class="step">
                 <h2 class="text-2xl font-semibold mb-2">Step 2: Project Setup</h2>
                <p class="text-gray-600 mb-6">Enter a project name and select which panels should be treated as Automation Server panels.</p>
                <div>
                    <label for="project-name" class="block text-sm font-medium text-gray-700 mb-1">Project Name</label>
                    <input type="text" id="project-name" class="w-full md:w-1/2 p-2 border border-gray-300 rounded-md shadow-sm" placeholder="e.g., New Office Building">
                </div>
                <div class="mt-6">
                    <h3 class="text-lg font-medium text-gray-800 mb-2">Select Server Panels</h3>
                    <div id="panel-checkboxes" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4 max-h-60 overflow-y-auto p-4 bg-gray-50 rounded-lg border"></div>
                </div>
                <div class="mt-8 flex justify-between items-center">
                    <button onclick="showStep('step-1')" class="text-gray-600 hover:text-gray-800 font-semibold">&larr; Back to Files</button>
                    <button id="to-step-3" class="bg-blue-600 text-white font-semibold py-2 px-6 rounded-lg shadow-md hover:bg-blue-700">
                        Next: Server Decisions &rarr;
                    </button>
                </div>
            </div>
            
            <!-- Step 3: Server Decisions -->
            <div id="step-3" class="step">
                 <h2 class="text-2xl font-semibold mb-2">Step 3: Server Type Decisions</h2>
                <p class="text-gray-600 mb-6">For each server panel, choose the most suitable automation server configuration.</p>
                <div id="decision-cards" class="space-y-6"></div>
                <div class="mt-8 flex justify-between items-center">
                    <button onclick="showStep('step-2')" class="text-gray-600 hover:text-gray-800 font-semibold">&larr; Back to Setup</button>
                    <button id="to-step-4" class="bg-green-600 text-white font-bold py-3 px-8 rounded-lg shadow-md hover:bg-green-700">
                        Generate Reports
                    </button>
                </div>
            </div>

            <!-- Step 4: Results -->
            <div id="step-4" class="step">
                <h2 class="text-2xl font-semibold mb-2">Step 4: Generated Reports</h2>
                <p class="text-gray-600 mb-6">Your project has been processed. Review the reports below and export them as CSV files.</p>
                <div class="mb-8">
                    <div class="flex justify-between items-center mb-2">
                        <h3 class="text-xl font-semibold text-gray-800">Panel Matrix</h3>
                        <button id="export-matrix" class="bg-gray-700 text-white text-sm font-semibold py-2 px-4 rounded-lg hover:bg-gray-800 transition-colors">Export Matrix CSV</button>
                    </div>
                    <div id="matrix-output" class="overflow-x-auto border rounded-lg"></div>
                </div>
                <div>
                    <div class="flex justify-between items-center mb-2">
                         <h3 class="text-xl font-semibold text-gray-800">Bill of Quantities (BOQ)</h3>
                         <button id="export-boq" class="bg-gray-700 text-white text-sm font-semibold py-2 px-4 rounded-lg hover:bg-gray-800 transition-colors">Export BOQ CSV</button>
                    </div>
                     <div id="boq-output" class="overflow-x-auto border rounded-lg"></div>
                </div>
                 <div class="mt-8 text-center">
                    <button onclick="window.location.reload()" class="text-blue-600 hover:text-blue-800 font-semibold">Start a New Project</button>
                </div>
            </div>
            
            <div id="loader-overlay" class="fixed inset-0 bg-white bg-opacity-75 flex-col items-center justify-center hidden z-50">
                <div class="loader"></div>
                <p id="loader-text" class="mt-4 text-lg font-semibold text-gray-700">Processing...</p>
            </div>
        </main>
    </div>

    <script>
        const appState = { projectName: '', serverPanelNames: new Set(), panelChoices: {}, finalReports: {}, serverOptionsCache: {} };
        const loader = document.getElementById('loader-overlay');
        const loaderText = document.getElementById('loader-text');
        function showStep(stepId) { document.querySelectorAll('.step').forEach(s => s.classList.remove('active')); document.getElementById(stepId).classList.add('active'); }
        const dropZone = document.getElementById('panels-drop-zone'); const fileInput = document.getElementById('panels-file');
        const statusEl = document.getElementById('panels-status');
        const handleFile = (file) => {
            if (!file || !file.name.endsWith('.csv')) { statusEl.textContent = 'Please upload a valid .csv file.'; return; }
            statusEl.textContent = 'Processing file...'; const formData = new FormData(); formData.append('panels_file', file);
            fetch('/get_panel_names', { method: 'POST', body: formData }).then(response => response.json()).then(data => {
                if (data.error) throw new Error(data.error);
                populatePanelSelection(data.panel_names); dropZone.classList.add('loaded');
                statusEl.textContent = `âœ… ${file.name} loaded`; document.getElementById('to-step-2').disabled = false;
            }).catch(err => {
                dropZone.classList.remove('loaded'); statusEl.textContent = `Error: ${err.message}`; document.getElementById('to-step-2').disabled = true;
            });
        };
        dropZone.addEventListener('dragover', (e) => { e.preventDefault(); dropZone.classList.add('dragover'); });
        dropZone.addEventListener('dragleave', () => dropZone.classList.remove('dragover'));
        dropZone.addEventListener('drop', (e) => { e.preventDefault(); dropZone.classList.remove('dragover'); if (e.dataTransfer.files.length) { handleFile(e.dataTransfer.files[0]); } });
        fileInput.addEventListener('change', () => handleFile(fileInput.files[0]));
        document.getElementById('to-step-2').addEventListener('click', () => showStep('step-2'));
        function populatePanelSelection(panelNames) {
            const container = document.getElementById('panel-checkboxes'); container.innerHTML = '';
            panelNames.forEach(panelName => {
                const div = document.createElement('div'); div.className = 'flex items-center';
                const id = `panel-${panelName.replace(/[^a-zA-Z0-9]/g, '-')}`;
                div.innerHTML = `<input type="checkbox" id="${id}" value="${panelName}" class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500"><label for="${id}" class="ml-2 block text-sm text-gray-900">${panelName}</label>`;
                div.querySelector('input').addEventListener('change', (e) => { e.target.checked ? appState.serverPanelNames.add(e.target.value) : appState.serverPanelNames.delete(e.target.value); });
                container.appendChild(div);
            });
        }
        document.getElementById('to-step-3').addEventListener('click', () => startDecisionPhase());
        async function startDecisionPhase() {
            appState.projectName = document.getElementById('project-name').value || 'Untitled_Project';
            if (appState.serverPanelNames.size === 0) { generateFinalReports(); } 
            else {
                loader.style.display = 'flex'; loaderText.textContent = 'Calculating Server Options...';
                const container = document.getElementById('decision-cards'); container.innerHTML = ''; appState.serverOptionsCache = {};
                const sortedServerPanels = [...appState.serverPanelNames].sort();
                for (const panelName of sortedServerPanels) {
                    try {
                        const response = await fetch('/calculate_options', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ panel_name: panelName }) });
                        const options = await response.json(); appState.serverOptionsCache[panelName] = options;
                        const card = document.createElement('div'); card.className = 'p-4 border rounded-lg shadow-sm bg-white';
                        card.innerHTML = `<h3 class="font-bold text-lg text-blue-800 mb-4">Decision for: ${panelName}</h3>`;
                        const optionsContainer = document.createElement('div'); optionsContainer.className = 'space-y-3';
                        if (!options || options.length === 0) { optionsContainer.innerHTML = '<p class="text-red-600">No valid server options found.</p>'; } 
                        else {
                            options.forEach((option, index) => {
                                 const optionId = `option-${panelName.replace(/[^a-zA-Z0-9]/g, '-')}-${index}`;
                                 optionsContainer.innerHTML += `<div class="flex items-center p-3 rounded-md border hover:bg-gray-50"><input type="radio" name="server-choice-${panelName}" id="${optionId}" value="${index}" class="h-4 w-4 text-blue-600 border-gray-300 focus:ring-blue-500" ${index === 0 ? 'checked' : ''}><label for="${optionId}" class="ml-3 flex justify-between w-full items-center"><span class="text-md font-medium text-gray-900">${option.name}</span><span class="text-md font-bold text-green-700">$${option.cost.toFixed(2)}</span></label></div>`;
                            });
                        }
                        card.appendChild(optionsContainer); container.appendChild(card);
                    } catch(err) { console.error(`Failed to get options for ${panelName}:`, err); }
                }
                loader.style.display = 'none'; showStep('step-3');
            }
        }
        document.getElementById('to-step-4').addEventListener('click', () => generateFinalReports());
        async function generateFinalReports() {
            loader.style.display = 'flex'; loaderText.textContent = 'Generating Final Reports...';
            const panelNames = Array.from(document.getElementById('panel-checkboxes').querySelectorAll('input')).map(cb => cb.value);
            const standardPanels = panelNames.filter(name => !appState.serverPanelNames.has(name)); appState.panelChoices = {}; 
            const decisionCards = document.getElementById('decision-cards').children;
            for (let i = 0; i < decisionCards.length; i++) {
                const card = decisionCards[i]; const panelName = card.querySelector('h3').textContent.replace('Decision for: ', '');
                const selectedRadio = card.querySelector('input[type="radio"]:checked');
                if (selectedRadio) {
                    const options = appState.serverOptionsCache[panelName]; const selectedIndex = parseInt(selectedRadio.value);
                    const chosenOption = options[selectedIndex];
                    if (!isNaN(selectedIndex) && chosenOption) {
                        // Create a deep copy to avoid mutating the cached data
                        const chosenOptionCopy = JSON.parse(JSON.stringify(chosenOption));
                        if (chosenOptionCopy.type === 'AS-P') { chosenOptionCopy.components['AS-P-Server'] = 1; }
                        appState.panelChoices[panelName] = chosenOptionCopy;
                    }
                } else { appState.panelChoices[panelName] = { components: { 'No Valid Server Solution': 0 } }; }
            }
            const response = await fetch('/generate_reports', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ panel_choices: appState.panelChoices, standard_panels: standardPanels }) });
            appState.finalReports = await response.json();
            renderTable('matrix-output', appState.finalReports.matrix); renderTable('boq-output', appState.finalReports.boq);
            loader.style.display = 'none'; showStep('step-4');
        }
        function renderTable(containerId, data) {
            const container = document.getElementById(containerId);
            if (!data || data.length === 0) { container.innerHTML = '<p class="p-4 text-center text-gray-500">No data to display.</p>'; return; }
            let headers = Object.keys(data[0]);
            const panelNameKey = headers.find(h => h.toLowerCase() === 'panelname'); const sumKey = headers.find(h => h.toLowerCase() === 'sum');
            if (panelNameKey) {
                let middleCols = headers.filter(h => h !== panelNameKey && h !== sumKey); middleCols.sort();
                headers = [panelNameKey, ...middleCols]; if (sumKey) { headers.push(sumKey); }
            }
            let table = '<table class="w-full text-sm text-left text-gray-500">';
            table += '<thead class="text-xs text-gray-700 uppercase bg-gray-100"><tr>';
            headers.forEach(h => table += `<th scope="col" class="px-4 py-3">${h}</th>`); table += '</tr></thead><tbody>';
            data.forEach(row => {
                const isTotalRow = String(row['ControllerName'] || '').includes('Grand Total');
                table += `<tr class="bg-white border-b hover:bg-gray-50 ${isTotalRow ? 'font-bold bg-gray-100' : ''}">`;
                headers.forEach((header) => {
                    let cellData = row[header];
                    if (typeof cellData === 'number' && (String(header).toLowerCase().includes('cost'))) { cellData = `$${cellData.toFixed(2)}`; }
                    const isHeaderCol = header === panelNameKey;
                    table += `<${isHeaderCol ? 'th' : 'td'} class="px-4 py-4 ${isHeaderCol ? 'font-medium text-gray-900 whitespace-nowrap' : ''}">${cellData !== null ? cellData : ''}</${isHeaderCol ? 'th' : 'td'}>`;
                });
                table += `</tr>`;
            });
            table += '</tbody></table>'; container.innerHTML = table;
        }
        function exportToCSV(data, defaultFilename) {
            if (!data || data.length === 0) return;
            let headers = Object.keys(data[0]); const panelNameKey = headers.find(h => h.toLowerCase() === 'panelname');
            const sumKey = headers.find(h => h.toLowerCase() === 'sum');
            if (panelNameKey) {
                let middleCols = headers.filter(h => h !== panelNameKey && h !== sumKey); middleCols.sort();
                headers = [panelNameKey, ...middleCols]; if (sumKey) { headers.push(sumKey); }
            }
            const csv = Papa.unparse({ fields: headers, data: data }); const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a"); const url = URL.createObjectURL(blob); link.setAttribute("href", url);
            const projectName = (document.getElementById('project-name').value || 'project').replace(/ /g, '_');
            link.setAttribute("download", `${projectName}_${defaultFilename}`); link.style.visibility = 'hidden';
            document.body.appendChild(link); link.click(); document.body.removeChild(link);
        }
        document.getElementById('export-matrix').addEventListener('click', () => exportToCSV(appState.finalReports.matrix, 'panel_matrix.csv'));
        document.getElementById('export-boq').addEventListener('click', () => exportToCSV(appState.finalReports.boq, 'project_boq.csv'));
    </script>
</body>
</html>
